<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in THAM GIA NHẬN QUÀ</title>
  <style>
    :root{
      --bg:#111827;
      --muted:#9aa4b2;
      --accent1:#5b4df7;
      --accent2:#9b5cf6;
      --card-bg: rgba(255,255,255,0.03);
      --input-bg: rgba(255,255,255,0.02);
      --text:#e6eef8;
    }
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;}
    body::before{content:"";position:fixed;inset:0;opacity:0.28;pointer-events:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="104" viewBox="0 0 120 104"><defs><pattern id="p" width="60" height="52" patternUnits="userSpaceOnUse"><path d="M30 0 L60 15 L60 37 L30 52 L0 37 L0 15 Z" fill="none" stroke="%234d5871" stroke-opacity="0.18" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>');transform:scale(1.03);mix-blend-mode:screen;}
    .wrap{position:relative;z-index:1;max-width:760px;margin:48px auto;padding:36px;border-radius:14px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04); box-shadow: 0 18px 40px rgba(3,7,18,0.55);}
    .titleTop{ text-align:center; margin-bottom:8px; }
    .it-icon{ width:68px;height:68px;border-radius:999px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background: linear-gradient(180deg, rgba(91,77,247,0.14), rgba(155,92,246,0.08)); border:1px solid rgba(255,255,255,0.03); box-shadow: 0 8px 28px rgba(91,77,247,0.12); }
    h1{font-weight:900;text-align:center;margin:8px 0;font-size:34px;letter-spacing:0.8px}
    .muted{color:var(--muted);text-align:center;margin-bottom:16px}
    .small-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600;color:var(--muted)}
    .label-upper{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:1px;margin-bottom:6px;}
    .input-lg{height:56px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(255,255,255,0.04);padding:14px;color:var(--text)}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;height:56px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(91,77,247,0.16)}
    .admin-link{display:block;text-align:center;color:var(--muted);margin-top:14px;text-decoration:underline;font-size:14px}
    .gear-btn{position:fixed; right:18px; top:18px; z-index:999; width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.025); border:1px solid rgba(255,255,255,0.04); cursor:pointer; box-shadow: 0 6px 18px rgba(2,6,23,0.5);}
    @media (max-width:520px){ .wrap{padding:20px} h1{font-size:26px} .it-icon{width:56px;height:56px} }
  </style>
</head>
<body>
  <div class="card">
    <h1>Check-in Sự Kiện</h1>
    <p class="meta">Nhập tên để nhận vé và số thứ tự</p>
    <label for="name">Tên của bạn</label>
    <input id="name" placeholder="Nhập tên..." />
    <button id="btnSubmit">NHẬN VÉ NGAY</button>
    <div class="meta">Đã check-in: <span id="count">0</span>/50</div>
  </div>

  <script type="module">
    // === Dán config Firebase của bạn dưới đây ===
    const firebaseConfig = {  apiKey: "AIzaSyDQYFb4jU4GM6jvNeoI2_ruaL2l40KE1-E",  authDomain: "eddy-2d7b9.firebaseapp.com",  projectId: "eddy-2d7b9",  storageBucket: "eddy-2d7b9.firebasestorage.app",  messagingSenderId: "457973266884",  appId: "1:457973266884:web:b07d771635523c70860c91",  measurementId: "G-EBGZ0TZL66"};

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, collection, query, orderBy, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const attendeesCol = collection(db, 'attendees');
    const metaDocRef = doc(db, 'meta', 'last_ticket');

    const teams = ['A','B','C','D','E','F','G','H','K','L'];
    const MAX = 50;

    const nameInput = document.getElementById('name');
    const btnSubmit = document.getElementById('btnSubmit');
    const countEl = document.getElementById('count');

    function numberToTeam(n){ return teams[Math.floor((n-1)/5)] || '?'; }

    async function loadCount(){
      try{
        const q = query(attendeesCol, orderBy('number'));
        const snap = await getDocs(q);
        countEl.textContent = snap.size;
      }catch(e){
        console.warn('loadCount', e);
      }
    }

    async function assignRandomNumber(name){
      name = name.trim();
      if(!name) throw new Error('Tên trống');

      // Lấy các số đã dùng
      const q = query(attendeesCol, orderBy('number'));
      const snap = await getDocs(q);
      const used = new Set();
      snap.forEach(d => { if(d.exists()) used.add(Number(d.data().number)); });

      const free = [];
      for(let i=1;i<=MAX;i++) if(!used.has(i)) free.push(i);
      if(free.length===0) throw new Error('Đã đầy (50/50)');

      const pick = free[Math.floor(Math.random()*free.length)];
      const team = numberToTeam(pick);
      const ts = new Date().toISOString();

      // Lưu doc với id = số (dễ quản lý)
      const docRef = doc(db, 'attendees', String(pick));
      await setDoc(docRef, { number: pick, name, team, ts });

      // Ghi last ticket để ticket.html đọc
      await setDoc(metaDocRef, { number: pick, name, team, ts });

      return { number: pick, name, team, ts };
    }

    btnSubmit.addEventListener('click', async ()=>{
      try{
        btnSubmit.disabled = true; btnSubmit.textContent = 'Đang xử lý...';
        const name = nameInput.value;
        const res = await assignRandomNumber(name);
        // chuyền sang trang vé
        window.location.href = 'ticket.html';
      }catch(e){
        alert(e.message || e);
      }finally{
        btnSubmit.disabled = false; btnSubmit.textContent = 'NHẬN VÉ NGAY';
        await loadCount();
      }
    });

    // init
    loadCount();
    nameInput.focus();
  </script>
</body>
</html>


